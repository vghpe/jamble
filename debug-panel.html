<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Jamble Debug Panel</title>
    <style>
      * {
        box-sizing: border-box;
      }
      
      body {
        margin: 0;
        padding: 16px;
        font-family: system-ui, sans-serif;
        font-size: 14px;
        background-color: #f8f9fa;
        height: 100vh;
        overflow-y: auto;
      }
      
      .debug-container {
        display: flex;
        flex-direction: column;
        gap: 12px;
        max-width: 100%;
      }
      
      .debug-header {
        background: #fff;
        padding: 12px 16px;
        border-radius: 8px;
        border: 1px solid #dee2e6;
        margin-bottom: 8px;
      }
      
      .debug-header h2 {
        margin: 0 0 8px 0;
        font-size: 16px;
        font-weight: 600;
        color: #212529;
      }
      
      .debug-info {
        margin: 0;
        font-size: 12px;
        color: #6c757d;
      }
      
      .debug-section {
        background: #fff;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
      }
      
      .debug-section.skill {
        background: #f9fff9;
        border-color: #cdeccd;
      }
      
      .debug-section.knob {
        background: #fff3e0;
        border-color: #ffcc02;
      }
      
      .section-header {
        background: #f8f9fa;
        padding: 12px 16px;
        font-weight: 600;
        border-bottom: 1px solid #dee2e6;
        cursor: pointer;
        user-select: none;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      
      .debug-section.skill .section-header {
        color: #2e7d32;
        background: #f9fff9;
        border-bottom-color: #cdeccd;
      }
      
      .debug-section.knob .section-header {
        color: #ef6c00;
        background: #fff3e0;
        border-bottom-color: #ffcc02;
      }
      
      .section-content {
        padding: 16px;
      }
      
      .form-grid {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 12px 16px;
        align-items: center;
      }
      
      .form-grid label {
        font-size: 13px;
        color: #495057;
        font-weight: 500;
      }
      
      .form-grid input[type="number"],
      .form-grid input[type="color"] {
        width: 120px;
        padding: 6px 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 13px;
      }
      
      .form-grid input[type="checkbox"] {
        width: auto;
        transform: scale(1.1);
      }
      
      .debug-buttons {
        display: flex;
        gap: 8px;
        margin-top: 12px;
      }
      
      .debug-btn {
        flex: 1;
        padding: 8px 12px;
        font-size: 12px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        background: #fff;
        color: #495057;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      .debug-btn:hover {
        background: #e9ecef;
      }
      
      .debug-btn.knob {
        border-color: #ffcc02;
        background: #fff3e0;
        color: #ef6c00;
      }
      
      .debug-btn.knob:hover {
        background: #ffecb3;
      }
      
      .debug-list {
        list-style: none;
        padding: 0;
        margin: 12px 0 0 0;
        font-size: 13px;
        color: #2e7d32;
      }
      
      .toggle-indicator {
        font-size: 12px;
        transition: transform 0.2s;
      }
      
      .section-collapsed .toggle-indicator {
        transform: rotate(-90deg);
      }
      
      .section-collapsed .section-content {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="debug-container">
      <div class="debug-header">
        <h2>üõ†Ô∏è Debug Panel</h2>
        <p class="debug-info">Changes apply immediately and reset on reload.</p>
      </div>

      <!-- Skills Section -->
      <div class="debug-section skill">
        <div class="section-header" onclick="toggleSection(this)">
          <span>Skill: Move</span>
          <span class="toggle-indicator">‚ñº</span>
        </div>
        <div class="section-content">
          <div class="form-grid">
            <label for="sk-moveSpeed">Speed</label>
            <input id="sk-moveSpeed" type="number" step="1" min="10" max="600">
          </div>
        </div>
      </div>

      <div class="debug-section skill">
        <div class="section-header" onclick="toggleSection(this)">
          <span>Skill: Jump</span>
          <span class="toggle-indicator">‚ñº</span>
        </div>
        <div class="section-content">
          <div class="form-grid">
            <label for="sk-jumpStrength">Strength</label>
            <input id="sk-jumpStrength" type="number" step="0.1" min="1" max="30">
            <label for="sk-jumpCd">Cooldown (ms)</label>
            <input id="sk-jumpCd" type="number" step="10" min="0" max="2000">
          </div>
        </div>
      </div>

      <div class="debug-section skill">
        <div class="section-header" onclick="toggleSection(this)">
          <span>Skill: Dash</span>
          <span class="toggle-indicator">‚ñº</span>
        </div>
        <div class="section-content">
          <div class="form-grid">
            <label for="sk-dashSpeed">Speed</label>
            <input id="sk-dashSpeed" type="number" step="5" min="0" max="1000">
            <label for="sk-dashDur">Duration (ms)</label>
            <input id="sk-dashDur" type="number" step="10" min="0" max="2000">
            <label for="sk-dashCd">Cooldown (ms)</label>
            <input id="sk-dashCd" type="number" step="10" min="0" max="2000">
          </div>
        </div>
      </div>

      <!-- Game Settings Section -->
      <div class="debug-section">
        <div class="section-header" onclick="toggleSection(this)">
          <span>Game Settings</span>
          <span class="toggle-indicator">‚ñº</span>
        </div>
        <div class="section-content">
          <div class="form-grid">
            <label for="dbg-mode">Ping-pong mode</label>
            <input id="dbg-mode" type="checkbox">
            <label for="dbg-squash">Squash animation</label>
            <input id="dbg-squash" type="checkbox">
            <label for="dbg-shuffleEnabled">Idle shuffle</label>
            <input id="dbg-shuffleEnabled" type="checkbox">
            <label for="dbg-shuffleLimit">Shuffles per idle</label>
            <input id="dbg-shuffleLimit" type="number" step="1" min="0" max="10">
          </div>
        </div>
      </div>

      <!-- Animation Section -->
      <div class="debug-section">
        <div class="section-header" onclick="toggleSection(this)">
          <span>Animation</span>
          <span class="toggle-indicator">‚ñº</span>
        </div>
        <div class="section-content">
          <div class="form-grid">
            <label for="dbg-stretch">Air stretch</label>
            <input id="dbg-stretch" type="number" step="0.005" min="0" max="0.2">
            <label for="dbg-squashFactor">Air squash</label>
            <input id="dbg-squashFactor" type="number" step="0.005" min="0" max="0.1">
            <label for="dbg-airMs">Air smoothing (ms)</label>
            <input id="dbg-airMs" type="number" step="10" min="0" max="500">
            <label for="dbg-landMs">Land squash (ms)</label>
            <input id="dbg-landMs" type="number" step="10" min="0" max="1000">
            <label for="dbg-landSY">Land scale Y</label>
            <input id="dbg-landSY" type="number" step="0.05" min="0.2" max="2">
            <label for="dbg-landSX">Land scale X</label>
            <input id="dbg-landSX" type="number" step="0.05" min="0.5" max="3">
            <label for="dbg-landEase">Land ease (ms)</label>
            <input id="dbg-landEase" type="number" step="10" min="0" max="1000">
          </div>
        </div>
      </div>

      <!-- Gravity Section -->
      <div class="debug-section">
        <div class="section-header" onclick="toggleSection(this)">
          <span>Gravity</span>
          <span class="toggle-indicator">‚ñº</span>
        </div>
        <div class="section-content">
          <div class="form-grid">
            <label for="dbg-gUp">Up gravity</label>
            <input id="dbg-gUp" type="number" step="0.01" min="0" max="5">
            <label for="dbg-gMid">Mid gravity</label>
            <input id="dbg-gMid" type="number" step="0.01" min="0" max="5">
            <label for="dbg-gDown">Down gravity</label>
            <input id="dbg-gDown" type="number" step="0.01" min="0" max="5">
          </div>
        </div>
      </div>

      <!-- Timings Section -->
      <div class="debug-section">
        <div class="section-header" onclick="toggleSection(this)">
          <span>Timings</span>
          <span class="toggle-indicator">‚ñº</span>
        </div>
        <div class="section-content">
          <div class="form-grid">
            <label for="dbg-startFreeze">Start freeze (ms)</label>
            <input id="dbg-startFreeze" type="number" step="50" min="0" max="6000">
            <label for="dbg-deathFreeze">Death freeze (ms)</label>
            <input id="dbg-deathFreeze" type="number" step="10" min="0" max="2000">
            <label for="dbg-resetDelay">Show reset delay (ms)</label>
            <input id="dbg-resetDelay" type="number" step="10" min="0" max="2000">
          </div>
        </div>
      </div>

      <!-- Geometry Section -->
      <div class="debug-section">
        <div class="section-header" onclick="toggleSection(this)">
          <span>Geometry</span>
          <span class="toggle-indicator">‚ñº</span>
        </div>
        <div class="section-content">
          <div class="form-grid">
            <label for="dbg-startOffset">Start offset (px)</label>
            <input id="dbg-startOffset" type="number" step="1" min="0" max="200">
            <label for="dbg-wiggleDist">Death wiggle (px)</label>
            <input id="dbg-wiggleDist" type="number" step="0.5" min="0" max="10">
            <label for="dbg-treeMargin">Tree edge margin (%)</label>
            <input id="dbg-treeMargin" type="number" step="1" min="0" max="50">
            <label for="dbg-treeGap">Tree gap (%)</label>
            <input id="dbg-treeGap" type="number" step="1" min="0" max="50">
          </div>
        </div>
      </div>

      <!-- Level Elements Section -->
      <div class="debug-section">
        <div class="section-header" onclick="toggleSection(this)">
          <span>Level Elements</span>
          <span class="toggle-indicator">‚ñº</span>
        </div>
        <div class="section-content">
          <div class="form-grid">
            <label for="dbg-elementEdit">Allow element removal</label>
            <input id="dbg-elementEdit" type="checkbox">
          </div>
          <ul id="dbg-deck" class="debug-list"></ul>
        </div>
      </div>

      <!-- Knob Element Section -->
      <div class="debug-section knob">
        <div class="section-header" onclick="toggleSection(this)">
          <span>üîî Knob Element</span>
          <span class="toggle-indicator">‚ñº</span>
        </div>
        <div class="section-content">
          <div class="form-grid">
            <label for="knob-length">Spring Length</label>
            <input id="knob-length" type="number" step="1" min="1">
            <label for="knob-segments">Segments</label>
            <input id="knob-segments" type="number" step="1" min="1">
            <label for="knob-omega">Frequency (œâ)</label>
            <input id="knob-omega" type="number" step="0.1" min="0.1">
            <label for="knob-zeta">Damping (Œ∂)</label>
            <input id="knob-zeta" type="number" step="0.01" min="0">
            <label for="knob-maxAngle">Max Angle (¬∞)</label>
            <input id="knob-maxAngle" type="number" step="1" min="1">
            <label for="knob-bow">Bow Factor</label>
            <input id="knob-bow" type="number" step="0.01" min="0">
            <label for="knob-lineWidth">Line Width</label>
            <input id="knob-lineWidth" type="number" step="0.1" min="0.1">
            <label for="knob-color">Color</label>
            <input id="knob-color" type="color">
            <label for="knob-baseRadius">Base Radius</label>
            <input id="knob-baseRadius" type="number" step="0.1" min="0.1">
            <label for="knob-visualOffsetY">Visual Offset Y</label>
            <input id="knob-visualOffsetY" type="number" step="1">
            <label for="knob-showPoints">Show Points</label>
            <input id="knob-showPoints" type="checkbox">
            <label for="dbg-emojiEnabled">Show emoji reactions</label>
            <input id="dbg-emojiEnabled" type="checkbox">
          </div>
          <div class="debug-buttons">
            <button id="knob-impulse" class="debug-btn knob">Apply Impulse to All</button>
          </div>
          <div class="debug-buttons">
            <button id="knob-collide-left" class="debug-btn knob">‚óÄ Collide Left</button>
            <button id="knob-collide-right" class="debug-btn knob">Collide Right ‚ñ∂</button>
          </div>
        </div>
      </div>

      <!-- Slot Debug Section -->
      <div class="debug-section">
        <div class="section-header" onclick="toggleSection(this)">
          <span>Slot Debug</span>
          <span class="toggle-indicator">‚ñº</span>
        </div>
        <div class="section-content">
          <div class="form-grid">
            <label for="dbg-slotOverlay">Show slot overlay</label>
            <input id="dbg-slotOverlay" type="checkbox">
            <label for="dbg-slotNoiseEnabled">Enable noise</label>
            <input id="dbg-slotNoiseEnabled" type="checkbox">
            <label for="dbg-slotNoiseX">Noise X scale</label>
            <input id="dbg-slotNoiseX" type="number" step="0.1" min="0" max="5">
            <label for="dbg-slotNoiseY">Noise Y scale</label>
            <input id="dbg-slotNoiseY" type="number" step="0.1" min="0" max="5">
            <label for="dbg-slotNormalEnabled">Bias slots toward center</label>
            <input id="dbg-slotNormalEnabled" type="checkbox">
            <label for="dbg-slotNormalIntensity">Center bias intensity</label>
            <input id="dbg-slotNormalIntensity" type="number" step="0.05" min="0" max="1">
          </div>
          <div class="debug-buttons">
            <button id="dbg-printSlots" class="debug-btn">Log active slots</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Section toggle functionality
      function toggleSection(header) {
        const section = header.closest('.debug-section');
        section.classList.toggle('section-collapsed');
      }

      // Full debug panel functionality adapted for iframe
      window.addEventListener('load', function() {
        if (!window.parent || !window.parent.__game) {
          console.log('‚ö†Ô∏è Debug panel could not connect to parent game');
          return;
        }

        console.log('‚úÖ Debug panel connected to game:', window.parent.__game);

        // Get references to parent window objects
        var game = window.parent.__game;
        var settings = window.parent.Jamble.Settings;
        var skillManager = game.getSkillManager();

        var controls = {
          moveSpeed: document.getElementById('sk-moveSpeed'),
          jumpStrength: document.getElementById('sk-jumpStrength'),
          jumpCooldown: document.getElementById('sk-jumpCd'),
          dashSpeed: document.getElementById('sk-dashSpeed'),
          dashDuration: document.getElementById('sk-dashDur'),
          dashCooldown: document.getElementById('sk-dashCd'),
          mode: document.getElementById('dbg-mode'),
          squashToggle: document.getElementById('dbg-squash'),
          stretch: document.getElementById('dbg-stretch'),
          squashFactor: document.getElementById('dbg-squashFactor'),
          airMs: document.getElementById('dbg-airMs'),
          landMs: document.getElementById('dbg-landMs'),
          landSY: document.getElementById('dbg-landSY'),
          landSX: document.getElementById('dbg-landSX'),
          landEase: document.getElementById('dbg-landEase'),
          gUp: document.getElementById('dbg-gUp'),
          gMid: document.getElementById('dbg-gMid'),
          gDown: document.getElementById('dbg-gDown'),
          startFreeze: document.getElementById('dbg-startFreeze'),
          deathFreeze: document.getElementById('dbg-deathFreeze'),
          resetDelay: document.getElementById('dbg-resetDelay'),
          startOffset: document.getElementById('dbg-startOffset'),
          wiggleDist: document.getElementById('dbg-wiggleDist'),
          treeMargin: document.getElementById('dbg-treeMargin'),
          treeGap: document.getElementById('dbg-treeGap'),
          shuffleEnabled: document.getElementById('dbg-shuffleEnabled'),
          shuffleLimit: document.getElementById('dbg-shuffleLimit'),
          // Knob controls
          knobLength: document.getElementById('knob-length'),
          knobSegments: document.getElementById('knob-segments'),
          knobOmega: document.getElementById('knob-omega'),
          knobZeta: document.getElementById('knob-zeta'),
          knobMaxAngle: document.getElementById('knob-maxAngle'),
          knobBow: document.getElementById('knob-bow'),
          knobLineWidth: document.getElementById('knob-lineWidth'),
          knobColor: document.getElementById('knob-color'),
          knobBaseRadius: document.getElementById('knob-baseRadius'),
          knobVisualOffsetY: document.getElementById('knob-visualOffsetY'),
          knobShowPoints: document.getElementById('knob-showPoints'),
          knobImpulse: document.getElementById('knob-impulse'),
          knobCollideLeft: document.getElementById('knob-collide-left'),
          knobCollideRight: document.getElementById('knob-collide-right'),
          emojiEnabled: document.getElementById('dbg-emojiEnabled'),
          slotOverlay: document.getElementById('dbg-slotOverlay'),
          slotPrint: document.getElementById('dbg-printSlots'),
          slotNoise: document.getElementById('dbg-slotNoiseEnabled'),
          slotNoiseX: document.getElementById('dbg-slotNoiseX'),
          slotNoiseY: document.getElementById('dbg-slotNoiseY'),
          slotNormal: document.getElementById('dbg-slotNormalEnabled'),
          slotNormalIntensity: document.getElementById('dbg-slotNormalIntensity'),
          elementEdit: document.getElementById('dbg-elementEdit')
        };

        var deckEl = document.getElementById('dbg-deck');

        function toNumber(value, fallback){
          var n = Number(value);
          return Number.isFinite(n) ? n : fallback;
        }

        function bindNumber(input, getter, setter){
          if (!input) return;
          input.addEventListener('change', function(){
            var current = getter();
            var value = toNumber(input.value, current);
            setter(value);
          });
        }

        function syncFromSettings(){
          var s = settings.current;
          if (controls.moveSpeed) controls.moveSpeed.value = String(s.playerSpeed);
          if (controls.mode) controls.mode.checked = (s.mode === 'pingpong');
          if (controls.squashToggle) controls.squashToggle.checked = !!s.squashEnabled;
          if (controls.stretch) controls.stretch.value = String(s.stretchFactor);
          if (controls.squashFactor) controls.squashFactor.value = String(s.squashFactor);
          if (controls.airMs) controls.airMs.value = String(s.airTransformSmoothingMs);
          if (controls.landMs) controls.landMs.value = String(s.landSquashDurationMs);
          if (controls.landSY) controls.landSY.value = String(s.landScaleY);
          if (controls.landSX) controls.landSX.value = String(s.landScaleX);
          if (controls.landEase) controls.landEase.value = String(s.landEaseMs);
          if (controls.gUp) controls.gUp.value = String(s.gravityUp);
          if (controls.gMid) controls.gMid.value = String(s.gravityMid);
          if (controls.gDown) controls.gDown.value = String(s.gravityDown);
          if (controls.startFreeze) controls.startFreeze.value = String(s.startFreezeTime);
          if (controls.deathFreeze) controls.deathFreeze.value = String(s.deathFreezeTime);
          if (controls.resetDelay) controls.resetDelay.value = String(s.showResetDelayMs);
          if (controls.startOffset) controls.startOffset.value = String(s.playerStartOffset);
          if (controls.wiggleDist) controls.wiggleDist.value = String(s.deathWiggleDistance);
          if (controls.treeMargin) controls.treeMargin.value = String(s.treeEdgeMarginPct);
          if (controls.treeGap) controls.treeGap.value = String(s.treeMinGapPct);
          if (controls.shuffleEnabled) controls.shuffleEnabled.checked = !!s.shuffleEnabled;
          if (controls.shuffleLimit) controls.shuffleLimit.value = String(s.shuffleLimit);

          // Knob settings
          var knobDefaults = {
            length: 10, segments: 6, omega: 18.0, zeta: 0.25, maxAngleDeg: 85,
            bowFactor: 0.35, lineWidth: 12, knobColor: '#ff968f', baseRadius: 3,
            showPoints: false, visualOffsetY: 4
          };
          window.parent.knobConfig = window.parent.knobConfig || { ...knobDefaults };
          var kc = window.parent.knobConfig;
          if (controls.knobLength) controls.knobLength.value = String(kc.length);
          if (controls.knobSegments) controls.knobSegments.value = String(kc.segments);
          if (controls.knobOmega) controls.knobOmega.value = String(kc.omega);
          if (controls.knobZeta) controls.knobZeta.value = String(kc.zeta);
          if (controls.knobMaxAngle) controls.knobMaxAngle.value = String(kc.maxAngleDeg);
          if (controls.knobBow) controls.knobBow.value = String(kc.bowFactor);
          if (controls.knobLineWidth) controls.knobLineWidth.value = String(kc.lineWidth);
          if (controls.knobColor) controls.knobColor.value = kc.knobColor;
          if (controls.knobBaseRadius) controls.knobBaseRadius.value = String(kc.baseRadius);
          if (controls.knobVisualOffsetY) controls.knobVisualOffsetY.value = String(kc.visualOffsetY);
          if (controls.knobShowPoints) controls.knobShowPoints.checked = !!kc.showPoints;

          var jumpCfg = settings.skills.configs.jump || {};
          if (controls.jumpStrength) controls.jumpStrength.value = String(jumpCfg.strength ?? s.jumpStrength);
          if (controls.jumpCooldown) controls.jumpCooldown.value = String(jumpCfg.cooldownMs ?? 0);
          var dashCfg = settings.skills.configs.dash || {};
          if (controls.dashSpeed) controls.dashSpeed.value = String(dashCfg.speed ?? s.dashSpeed);
          if (controls.dashDuration) controls.dashDuration.value = String(dashCfg.durationMs ?? s.dashDurationMs);
          if (controls.dashCooldown) controls.dashCooldown.value = String(dashCfg.cooldownMs ?? 150);

          renderDeckList();
        }

        function renderDeckList(){
          if (!deckEl || !game.getElementDeck) return;
          var hand = game.getElementHand ? game.getElementHand() : [];
          var deck = game.getElementDeck();
          deckEl.innerHTML = '';
          deck.forEach(function(card){
            var li = document.createElement('li');
            var inHand = hand.some(function(h){ return h.id === card.id && h.available; });
            li.textContent = card.name + (inHand ? ' (in hand)' : '');
            deckEl.appendChild(li);
          });
        }

        // Bind all the controls
        if (controls.moveSpeed) bindNumber(controls.moveSpeed, function(){ return settings.current.playerSpeed; }, function(value){ settings.update({ playerSpeed: value }); });
        if (controls.mode) controls.mode.addEventListener('change', function(){ settings.update({ mode: controls.mode.checked ? 'pingpong' : 'idle' }); });
        if (controls.squashToggle) controls.squashToggle.addEventListener('change', function(){ settings.update({ squashEnabled: controls.squashToggle.checked }); });
        
        bindNumber(controls.stretch, function(){ return settings.current.stretchFactor; }, function(value){ settings.update({ stretchFactor: value }); });
        bindNumber(controls.squashFactor, function(){ return settings.current.squashFactor; }, function(value){ settings.update({ squashFactor: value }); });
        bindNumber(controls.airMs, function(){ return settings.current.airTransformSmoothingMs; }, function(value){ settings.update({ airTransformSmoothingMs: value }); });
        bindNumber(controls.landMs, function(){ return settings.current.landSquashDurationMs; }, function(value){ settings.update({ landSquashDurationMs: value }); });
        bindNumber(controls.landSY, function(){ return settings.current.landScaleY; }, function(value){ settings.update({ landScaleY: value }); });
        bindNumber(controls.landSX, function(){ return settings.current.landScaleX; }, function(value){ settings.update({ landScaleX: value }); });
        bindNumber(controls.landEase, function(){ return settings.current.landEaseMs; }, function(value){ settings.update({ landEaseMs: value }); });
        bindNumber(controls.gUp, function(){ return settings.current.gravityUp; }, function(value){ settings.update({ gravityUp: value }); });
        bindNumber(controls.gMid, function(){ return settings.current.gravityMid; }, function(value){ settings.update({ gravityMid: value }); });
        bindNumber(controls.gDown, function(){ return settings.current.gravityDown; }, function(value){ settings.update({ gravityDown: value }); });
        bindNumber(controls.startFreeze, function(){ return settings.current.startFreezeTime; }, function(value){ settings.update({ startFreezeTime: value }); });
        bindNumber(controls.deathFreeze, function(){ return settings.current.deathFreezeTime; }, function(value){ settings.update({ deathFreezeTime: value }); });
        bindNumber(controls.resetDelay, function(){ return settings.current.showResetDelayMs; }, function(value){ settings.update({ showResetDelayMs: value }); });
        bindNumber(controls.startOffset, function(){ return settings.current.playerStartOffset; }, function(value){ settings.update({ playerStartOffset: value }); });
        bindNumber(controls.wiggleDist, function(){ return settings.current.deathWiggleDistance; }, function(value){ settings.update({ deathWiggleDistance: value }); });
        bindNumber(controls.treeMargin, function(){ return settings.current.treeEdgeMarginPct; }, function(value){ settings.update({ treeEdgeMarginPct: value }); });
        bindNumber(controls.treeGap, function(){ return settings.current.treeMinGapPct; }, function(value){ settings.update({ treeMinGapPct: value }); });
        if (controls.shuffleEnabled) controls.shuffleEnabled.addEventListener('change', function(){ settings.update({ shuffleEnabled: controls.shuffleEnabled.checked }); });
        bindNumber(controls.shuffleLimit, function(){ return settings.current.shuffleLimit; }, function(value){ settings.update({ shuffleLimit: value }); });

        // Skill controls with proper config updates
        function applySkillsFromSettings(){
          var jumpCfg = settings.skills.configs.jump || {};
          var dashCfg = settings.skills.configs.dash || {};
          skillManager.clear();
          if (Object.keys(jumpCfg).length) skillManager.setConfig('jump', { ...jumpCfg });
          if (Object.keys(dashCfg).length) skillManager.setConfig('dash', { ...dashCfg });
          var lineup = ['move','jump','dash']; // simplified for debug panel
          lineup.forEach(function(id){ try { skillManager.equip(id); } catch(_e){} });
        }

        bindNumber(controls.jumpStrength, function(){ return settings.skills.configs.jump?.strength ?? settings.current.jumpStrength; }, function(value){
          settings.update({ jumpStrength: value });
          settings.skills.configs.jump = { ...(settings.skills.configs.jump || {}), strength: value };
          applySkillsFromSettings();
        });
        bindNumber(controls.jumpCooldown, function(){ return settings.skills.configs.jump?.cooldownMs ?? 0; }, function(value){
          settings.skills.configs.jump = { ...(settings.skills.configs.jump || {}), cooldownMs: value };
          applySkillsFromSettings();
        });
        bindNumber(controls.dashSpeed, function(){ return settings.skills.configs.dash?.speed ?? settings.current.dashSpeed; }, function(value){
          settings.update({ dashSpeed: value });
          settings.skills.configs.dash = { ...(settings.skills.configs.dash || {}), speed: value };
          applySkillsFromSettings();
        });
        bindNumber(controls.dashDuration, function(){ return settings.skills.configs.dash?.durationMs ?? settings.current.dashDurationMs; }, function(value){
          settings.update({ dashDurationMs: value });
          settings.skills.configs.dash = { ...(settings.skills.configs.dash || {}), durationMs: value };
          applySkillsFromSettings();
        });
        bindNumber(controls.dashCooldown, function(){ return settings.skills.configs.dash?.cooldownMs ?? 150; }, function(value){
          settings.skills.configs.dash = { ...(settings.skills.configs.dash || {}), cooldownMs: value };
          applySkillsFromSettings();
        });

        // Knob controls
        function updateAllKnobs() {
          var parentDoc = window.parent.document;
          var knobs = Array.from(parentDoc.querySelectorAll('.jamble-knob')).map(function(el) {
            return el.__knob_instance;
          }).filter(Boolean);
          
          knobs.forEach(function(knob) {
            if (knob.updateConfig) {
              knob.updateConfig(window.parent.knobConfig);
            }
          });
        }

        function bindKnobNumber(input, prop) {
          if (!input) return;
          input.addEventListener('change', function() {
            var value = toNumber(input.value, window.parent.knobConfig[prop]);
            window.parent.knobConfig[prop] = value;
            updateAllKnobs();
          });
        }

        bindKnobNumber(controls.knobLength, 'length');
        bindKnobNumber(controls.knobSegments, 'segments');
        bindKnobNumber(controls.knobOmega, 'omega');
        bindKnobNumber(controls.knobZeta, 'zeta');
        bindKnobNumber(controls.knobMaxAngle, 'maxAngleDeg');
        bindKnobNumber(controls.knobBow, 'bowFactor');
        bindKnobNumber(controls.knobLineWidth, 'lineWidth');
        bindKnobNumber(controls.knobBaseRadius, 'baseRadius');
        bindKnobNumber(controls.knobVisualOffsetY, 'visualOffsetY');

        if (controls.knobColor) {
          controls.knobColor.addEventListener('change', function() {
            window.parent.knobConfig.knobColor = controls.knobColor.value;
            updateAllKnobs();
          });
        }

        if (controls.knobShowPoints) {
          controls.knobShowPoints.addEventListener('change', function() {
            window.parent.knobConfig.showPoints = controls.knobShowPoints.checked;
            updateAllKnobs();
          });
        }

        if (controls.emojiEnabled) {
          controls.emojiEnabled.addEventListener('change', function() {
            if (game && typeof game.setEmojiEnabled === 'function') {
              game.setEmojiEnabled(controls.emojiEnabled.checked);
            }
          });
        }

        if (controls.knobImpulse) {
          controls.knobImpulse.addEventListener('click', function() {
            var parentDoc = window.parent.document;
            var knobs = Array.from(parentDoc.querySelectorAll('.jamble-knob')).map(function(el) {
              return el.__knob_instance;
            }).filter(Boolean);
            
            knobs.forEach(function(knob) {
              if (knob.applyImpulse) {
                knob.applyImpulse(3);
              }
            });
          });
        }

        // Collision buttons for knobs
        function attachCollisionHandler(button, direction) {
          if (!button) return;
          
          function startCollision() {
            var parentDoc = window.parent.document;
            var knobs = Array.from(parentDoc.querySelectorAll('.jamble-knob')).map(function(el) {
              return el.__knob_instance;
            }).filter(Boolean);
            
            knobs.forEach(function(knob) {
              if (knob.beginCollision) {
                knob.beginCollision(direction);
              }
            });
            button.style.backgroundColor = '#ff6600';
            button.style.color = '#ffffff';
          }
          
          function endCollision() {
            var parentDoc = window.parent.document;
            var knobs = Array.from(parentDoc.querySelectorAll('.jamble-knob')).map(function(el) {
              return el.__knob_instance;
            }).filter(Boolean);
            
            knobs.forEach(function(knob) {
              if (knob.endCollision) {
                knob.endCollision();
              }
            });
            button.style.backgroundColor = '#fff3e0';
            button.style.color = '#ef6c00';
          }

          button.addEventListener('pointerdown', startCollision);
          button.addEventListener('pointerup', endCollision);
          button.addEventListener('pointercancel', endCollision);
          button.addEventListener('pointerleave', endCollision);
        }

        attachCollisionHandler(controls.knobCollideLeft, 1);
        attachCollisionHandler(controls.knobCollideRight, -1);

        if (controls.slotPrint) {
          controls.slotPrint.addEventListener('click', function(){
            console.log('Active slots:', game.debugActiveSlots ? game.debugActiveSlots() : 'N/A');
          });
        }

        // Initialize everything
        syncFromSettings();
        applySkillsFromSettings();
        renderDeckList();

        console.log('üéÆ Debug panel fully initialized!');
      });
    </script>
  </body>
</html>