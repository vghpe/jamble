<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Jamble Demo</title>
    <link rel="stylesheet" href="./dist/jamble.css" />
  </head>
  <body>
    <h1 style="text-align:center;font-family:system-ui,sans-serif">Jamble Demo</h1>
    <div id="jamble">
      <div class="jamble-game">
        <div class="jamble-player jamble-player-idle"></div>
        <div class="jamble-tree" data-tree="1" style="left: 35%"></div>
        <div class="jamble-tree" data-tree="2" style="left: 65%"></div>
        <div class="jamble-level">0</div>
        <div class="jamble-countdown">3</div>
        <button class="jamble-reset" title="Reset">↻</button>
      </div>
      <div class="jamble-controls">
        <button class="jamble-start" title="Start">▶</button>
        <button class="jamble-shuffle" title="Shuffle">⇄</button>
      </div>
    </div>

    <!-- Minimal Debug Panel -->
    <div id="jamble-debug" style="position:fixed;left:0;bottom:12px;width:100%;padding:0 12px;box-sizing:border-box;font-family:system-ui,sans-serif;z-index:1000">
      <details open>
        <summary>Debug</summary>
        <div style="display:flex;justify-content:space-between;align-items:center;margin:8px 0 4px 0;gap:8px">
          <div style="display:flex;gap:8px;align-items:center">
            <label for="dbg-profile" style="font-size:12px;color:#555">Profile</label>
            <select id="dbg-profile" style="min-width:200px"></select>
            <button id="dbg-save" type="button">Save</button>
            <button id="dbg-saveAs" type="button">Save As…</button>
            <button id="dbg-revert" type="button">Revert changes</button>
          </div>
          <div style="display:flex;gap:12px;align-items:center">
            <div id="dbg-dirty" style="font-size:12px;color:#a00;min-width:120px;text-align:right;visibility:hidden">Unsaved changes</div>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;align-items:start;margin-top:8px">
          <!-- Movement & Mode -->
          <div style="display:grid;grid-template-columns:1fr auto;gap:6px;align-items:center;background:#fff;padding:8px;border-radius:6px;border:1px solid #ddd">
            <label for="dbg-jump">Jump strength</label>
            <input id="dbg-jump" type="number" step="0.1" min="1" max="30" style="width:100px">
            <label for="dbg-speed">Player speed</label>
            <input id="dbg-speed" type="number" step="1" min="10" max="600" style="width:100px">
            <label for="dbg-mode">Ping-pong mode</label>
            <input id="dbg-mode" type="checkbox" style="width:auto">
            <label for="dbg-squash">Squash animation</label>
            <input id="dbg-squash" type="checkbox" style="width:auto">
          </div>

          <!-- Dash -->
          <div style="display:grid;grid-template-columns:1fr auto;gap:6px;align-items:center;background:#fff;padding:8px;border-radius:6px;border:1px solid #ddd">
            <label for="dbg-dashSpeed">Dash speed</label>
            <input id="dbg-dashSpeed" type="number" step="5" min="0" max="1000" style="width:100px">
            <label for="dbg-dashDur">Dash duration (ms)</label>
            <input id="dbg-dashDur" type="number" step="10" min="0" max="1000" style="width:100px">
          </div>

          <!-- Animation Params -->
          <div style="display:grid;grid-template-columns:1fr auto;gap:6px;align-items:center;background:#fff;padding:8px;border-radius:6px;border:1px solid #ddd">
            <label for="dbg-stretch">J stretch factor</label>
            <input id="dbg-stretch" type="number" step="0.005" min="0" max="0.2" style="width:100px">
            <label for="dbg-squashFactor">J squash factor</label>
            <input id="dbg-squashFactor" type="number" step="0.005" min="0" max="0.1" style="width:100px">
            <label for="dbg-airMs">J smooth (ms)</label>
            <input id="dbg-airMs" type="number" step="10" min="0" max="500" style="width:100px">
            <label for="dbg-landMs">Landing squash (ms)</label>
            <input id="dbg-landMs" type="number" step="10" min="0" max="1000" style="width"="100px">
            <label for="dbg-landSY">L squash scale Y</label>
            <input id="dbg-landSY" type="number" step="0.05" min="0.2" max="2" style="width:100px">
            <label for="dbg-landSX">L squash scale X</label>
            <input id="dbg-landSX" type="number" step="0.05" min="0.5" max="3" style="width:100px">
            <label for="dbg-landEase">L ease (ms)</label>
            <input id="dbg-landEase" type="number" step="10" min="0" max="1000" style="width:100px">
          </div>

          <!-- Physics (Gravity) -->
          <div style="display:grid;grid-template-columns:1fr auto;gap:6px;align-items:center;background:#fff;padding:8px;border-radius:6px;border:1px solid #ddd">
            <label for="dbg-gUp">Gravity up</label>
            <input id="dbg-gUp" type="number" step="0.01" min="0" max="5" style="width:100px">
            <label for="dbg-gMid">Gravity mid</label>
            <input id="dbg-gMid" type="number" step="0.01" min="0" max="5" style="width:100px">
            <label for="dbg-gDown">Gravity down</label>
            <input id="dbg-gDown" type="number" step="0.01" min="0" max="5" style="width:100px">
          </div>

          <!-- Timings -->
          <div style="display:grid;grid-template-columns:1fr auto;gap:6px;align-items:center;background:#fff;padding:8px;border-radius:6px;border:1px solid #ddd">
            <label for="dbg-startFreeze">Start freeze (ms)</label>
            <input id="dbg-startFreeze" type="number" step="50" min="0" max="10000" style="width:100px">
            <label for="dbg-deathFreeze">Death freeze (ms)</label>
            <input id="dbg-deathFreeze" type="number" step="10" min="0" max="5000" style="width:100px">
            <label for="dbg-resetDelay">Show reset delay (ms)</label>
            <input id="dbg-resetDelay" type="number" step="10" min="0" max="2000" style="width:100px">
          </div>

          <!-- Geometry / Trees -->
          <div style="display:grid;grid-template-columns:1fr auto;gap:6px;align-items:center;background:#fff;padding:8px;border-radius:6px;border:1px solid #ddd">
            <label for="dbg-startOffset">Player start offset (px)</label>
            <input id="dbg-startOffset" type="number" step="1" min="0" max="200" style="width:100px">
            <label for="dbg-wiggleDist">Death wiggle distance (px)</label>
            <input id="dbg-wiggleDist" type="number" step="0.5" min="0" max="10" style="width:100px">
            <label for="dbg-treeMargin">Tree edge margin (%)</label>
            <input id="dbg-treeMargin" type="number" step="1" min="0" max="40" style="width:100px">
            <label for="dbg-treeGap">Tree min gap (%)</label>
            <input id="dbg-treeGap" type="number" step="1" min="5" max="80" style="width:100px">
          </div>
        </div>
      </details>
    </div>

    <script src="./dist/jamble.js"></script>
    <script>
      (function(){
        if (!window.Jamble || !window.Jamble.Game) return;
        var root = document.getElementById('jamble');
        var game = new window.Jamble.Game(root);
        game.start();

        // Debug bindings
        var jumpEl = document.getElementById('dbg-jump');
        var speedEl = document.getElementById('dbg-speed');
        var modeEl = document.getElementById('dbg-mode');
        var squashEl = document.getElementById('dbg-squash');
        var dashSpeedEl = document.getElementById('dbg-dashSpeed');
        var dashDurEl = document.getElementById('dbg-dashDur');
        var stretchEl = document.getElementById('dbg-stretch');
        var squashFactorEl = document.getElementById('dbg-squashFactor');
        var airMsEl = document.getElementById('dbg-airMs');
        var landMsEl = document.getElementById('dbg-landMs');
        var landSYEl = document.getElementById('dbg-landSY');
        var landSXEl = document.getElementById('dbg-landSX');
        var landEaseEl = document.getElementById('dbg-landEase');
        var gUpEl = document.getElementById('dbg-gUp');
        var gMidEl = document.getElementById('dbg-gMid');
        var gDownEl = document.getElementById('dbg-gDown');
        var startFreezeEl = document.getElementById('dbg-startFreeze');
        var deathFreezeEl = document.getElementById('dbg-deathFreeze');
        var resetDelayEl = document.getElementById('dbg-resetDelay');
        var startOffsetEl = document.getElementById('dbg-startOffset');
        var wiggleDistEl = document.getElementById('dbg-wiggleDist');
        var treeMarginEl = document.getElementById('dbg-treeMargin');
        var treeGapEl = document.getElementById('dbg-treeGap');
        var saveBtn = document.getElementById('dbg-save');
        var profileSel = document.getElementById('dbg-profile');
        var revertBtn = document.getElementById('dbg-revert');
        var saveAsBtn = document.getElementById('dbg-saveAs');
        var dirtyEl = document.getElementById('dbg-dirty');

        var baselineJSON = null; // stringified snapshot of last loaded/saved profile

        function clamp(n, min, max){ n = Number(n); if (Number.isNaN(n)) return min; return Math.max(min, Math.min(max, n)); }
        function syncFromSettings(){
          var s = window.Jamble.Settings.current;
          if (jumpEl) jumpEl.value = String(s.jumpStrength);
          if (speedEl) speedEl.value = String(s.playerSpeed);
          if (modeEl) modeEl.checked = (s.mode === 'pingpong');
          if (squashEl) squashEl.checked = !!s.squashEnabled;
          if (dashSpeedEl) dashSpeedEl.value = String(s.dashSpeed);
          if (dashDurEl) dashDurEl.value = String(s.dashDurationMs);
          if (stretchEl) stretchEl.value = String(s.stretchFactor);
          if (squashFactorEl) squashFactorEl.value = String(s.squashFactor);
          if (airMsEl) airMsEl.value = String(s.airTransformSmoothingMs);
          if (landMsEl) landMsEl.value = String(s.landSquashDurationMs);
          if (landSYEl) landSYEl.value = String(s.landScaleY);
          if (landSXEl) landSXEl.value = String(s.landScaleX);
          if (landEaseEl) landEaseEl.value = String(s.landEaseMs);
          if (gUpEl) gUpEl.value = String(s.gravityUp);
          if (gMidEl) gMidEl.value = String(s.gravityMid);
          if (gDownEl) gDownEl.value = String(s.gravityDown);
          if (startFreezeEl) startFreezeEl.value = String(s.startFreezeTime);
          if (deathFreezeEl) deathFreezeEl.value = String(s.deathFreezeTime);
          if (resetDelayEl) resetDelayEl.value = String(s.showResetDelayMs);
          if (startOffsetEl) startOffsetEl.value = String(s.playerStartOffset);
          if (wiggleDistEl) wiggleDistEl.value = String(s.deathWiggleDistance);
          if (treeMarginEl) treeMarginEl.value = String(s.treeEdgeMarginPct);
          if (treeGapEl) treeGapEl.value = String(s.treeMinGapPct);
          // do not change baseline here; use markBaseline() when profile load/reset/save happens
          updateDirty();
          updateSaveEnabled();
        }
        function markBaseline(){ baselineJSON = JSON.stringify(window.Jamble.Settings.toJSON()); updateDirty(); updateSaveEnabled(); }
        function updateSaveEnabled(){
          if (!saveBtn) return;
          var name = (window.Jamble.Settings && window.Jamble.Settings.activeName) || 'default.json';
          saveBtn.disabled = (name === 'default.json');
          saveBtn.title = saveBtn.disabled ? 'Cannot save over default.json' : '';
        }
        function updateDirty(){
          if (!dirtyEl) return;
          try {
            var now = JSON.stringify(window.Jamble.Settings.toJSON());
            var isDirty = baselineJSON !== null && now !== baselineJSON;
            dirtyEl.style.visibility = isDirty ? 'visible' : 'hidden';
          } catch(_e){ dirtyEl.style.visibility = 'hidden'; }
        }
        function onInput(){
          var j = jumpEl ? clamp(jumpEl.value, 1, 30) : undefined;
          var p = speedEl ? clamp(speedEl.value, 10, 600) : undefined;
          var st = stretchEl ? clamp(stretchEl.value, 0, 0.2) : undefined;
          var sq = squashFactorEl ? clamp(squashFactorEl.value, 0, 0.1) : undefined;
          var am = airMsEl ? clamp(airMsEl.value, 0, 500) : undefined;
          var lm = landMsEl ? clamp(landMsEl.value, 0, 1000) : undefined;
          var lsy = landSYEl ? clamp(landSYEl.value, 0.2, 2) : undefined;
          var lsx = landSXEl ? clamp(landSXEl.value, 0.5, 3) : undefined;
          var le = landEaseEl ? clamp(landEaseEl.value, 0, 1000) : undefined;
          var ds = dashSpeedEl ? clamp(dashSpeedEl.value, 0, 1000) : undefined;
          var dd = dashDurEl ? clamp(dashDurEl.value, 0, 1000) : undefined;
          var gu = gUpEl ? clamp(gUpEl.value, 0, 5) : undefined;
          var gm = gMidEl ? clamp(gMidEl.value, 0, 5) : undefined;
          var gd = gDownEl ? clamp(gDownEl.value, 0, 5) : undefined;
          var sf = startFreezeEl ? clamp(startFreezeEl.value, 0, 10000) : undefined;
          var df = deathFreezeEl ? clamp(deathFreezeEl.value, 0, 5000) : undefined;
          var rd = resetDelayEl ? clamp(resetDelayEl.value, 0, 2000) : undefined;
          var so = startOffsetEl ? clamp(startOffsetEl.value, 0, 200) : undefined;
          var wd = wiggleDistEl ? clamp(wiggleDistEl.value, 0, 10) : undefined;
          var tm = treeMarginEl ? clamp(treeMarginEl.value, 0, 40) : undefined;
          var tg = treeGapEl ? clamp(treeGapEl.value, 5, 80) : undefined;
          var patch = {};
          if (j !== undefined) patch.jumpStrength = Number(j);
          if (p !== undefined) patch.playerSpeed = Number(p);
          if (modeEl) patch.mode = modeEl.checked ? 'pingpong' : 'idle';
          if (squashEl) patch.squashEnabled = !!squashEl.checked;
          if (ds !== undefined) patch.dashSpeed = Math.round(Number(ds));
          if (dd !== undefined) patch.dashDurationMs = Math.round(Number(dd));
          if (st !== undefined) patch.stretchFactor = Number(st);
          if (sq !== undefined) patch.squashFactor = Number(sq);
          if (am !== undefined) patch.airTransformSmoothingMs = Math.round(Number(am));
          if (lm !== undefined) patch.landSquashDurationMs = Math.round(Number(lm));
          if (lsy !== undefined) patch.landScaleY = Number(lsy);
          if (lsx !== undefined) patch.landScaleX = Number(lsx);
          if (le !== undefined) patch.landEaseMs = Math.round(Number(le));
          if (gu !== undefined) patch.gravityUp = Number(gu);
          if (gm !== undefined) patch.gravityMid = Number(gm);
          if (gd !== undefined) patch.gravityDown = Number(gd);
          if (sf !== undefined) patch.startFreezeTime = Math.round(Number(sf));
          if (df !== undefined) patch.deathFreezeTime = Math.round(Number(df));
          if (rd !== undefined) patch.showResetDelayMs = Math.round(Number(rd));
          if (so !== undefined) patch.playerStartOffset = Math.round(Number(so));
          if (wd !== undefined) patch.deathWiggleDistance = Number(wd);
          if (tm !== undefined) patch.treeEdgeMarginPct = Math.round(Number(tm));
          if (tg !== undefined) patch.treeMinGapPct = Math.round(Number(tg));
          window.Jamble.Settings.update(patch);
          updateDirty();
        }
        if (jumpEl) jumpEl.addEventListener('input', onInput);
        if (speedEl) speedEl.addEventListener('input', onInput);
        if (modeEl) modeEl.addEventListener('change', onInput);
        if (squashEl) squashEl.addEventListener('change', onInput);
        if (dashSpeedEl) dashSpeedEl.addEventListener('input', onInput);
        if (dashDurEl) dashDurEl.addEventListener('input', onInput);
        if (stretchEl) stretchEl.addEventListener('input', onInput);
        if (squashFactorEl) squashFactorEl.addEventListener('input', onInput);
        if (airMsEl) airMsEl.addEventListener('input', onInput);
        if (landMsEl) landMsEl.addEventListener('input', onInput);
        if (landSYEl) landSYEl.addEventListener('input', onInput);
        if (landSXEl) landSXEl.addEventListener('input', onInput);
        if (landEaseEl) landEaseEl.addEventListener('input', onInput);
        if (gUpEl) gUpEl.addEventListener('input', onInput);
        if (gMidEl) gMidEl.addEventListener('input', onInput);
        if (gDownEl) gDownEl.addEventListener('input', onInput);
        if (startFreezeEl) startFreezeEl.addEventListener('input', onInput);
        if (deathFreezeEl) deathFreezeEl.addEventListener('input', onInput);
        if (resetDelayEl) resetDelayEl.addEventListener('input', onInput);
        if (startOffsetEl) startOffsetEl.addEventListener('input', onInput);
        if (wiggleDistEl) wiggleDistEl.addEventListener('input', onInput);
        if (treeMarginEl) treeMarginEl.addEventListener('input', onInput);
        if (treeGapEl) treeGapEl.addEventListener('input', onInput);

        // Save/Load/Reset wiring
        function saveProfile(){
          var name = window.Jamble.Settings.activeName || 'default.json';
          if (name === 'default.json') return; // block saving over default
          fetch('/__profiles/' + encodeURIComponent(name), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(window.Jamble.Settings.toJSON())
          }).then(function(res){ if (!res.ok) throw new Error('Save failed'); return res.text(); })
            .then(function(){
              // Update store baseline to the newly saved values so Revert matches the save
              if (window.Jamble && window.Jamble.Settings && window.Jamble.Settings.markBaseline){
                window.Jamble.Settings.markBaseline(name);
              }
              markBaseline();
            })
            .catch(function(err){ console.error(err); });
        }
        function revertProfile(){
          window.Jamble.Settings.revertToProfile();
          syncFromSettings();
          // no need to change baseline; current now equals baseline, so dirty clears
          updateDirty();
        }
        var profilesCache = [];
        function populateProfiles(){
          fetch('/__profiles').then(function(r){ return r.json(); }).then(function(data){
            var list = (data && data.profiles) || [];
            profilesCache = list.slice();
            if (!profileSel) return;
            profileSel.innerHTML = '';
            list.forEach(function(name){
              var opt = document.createElement('option');
              opt.value = name; opt.textContent = name; profileSel.appendChild(opt);
            });
            // Try to select the active one
            var active = window.Jamble.Settings.activeName || 'default.json';
            var found = Array.from(profileSel.options).some(function(o){ return o.value === active; });
            profileSel.value = found ? active : (list[0] || '');
            updateSaveEnabled();
          }).catch(function(err){ console.error(err); });
        }
        function suggestName(){
          var active = window.Jamble.Settings.activeName || 'default.json';
          if (active.toLowerCase() === 'default.json') return 'my-profile.json';
          if (active.toLowerCase().endsWith('.json')) return active.slice(0, -5) + '-copy.json';
          return active + '-copy.json';
        }
        function validateFileName(name){
          if (!name) return null;
          name = String(name).trim();
          if (!name.toLowerCase().endsWith('.json')) name += '.json';
          if (name.includes('/') || name.includes('\\')) return null;
          if (name.toLowerCase() === 'default.json') return null;
          return name;
        }
        function saveAsProfile(){
          var name = prompt('Save as filename (saved under dist/profiles/):', suggestName());
          name = validateFileName(name);
          if (!name){ alert('Invalid filename. Must be a .json under dist/profiles and not "default.json".'); return; }
          var exists = profilesCache.indexOf(name) !== -1;
          if (exists && !confirm('"' + name + '" already exists. Overwrite?')) return;
          fetch('/__profiles/' + encodeURIComponent(name), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(window.Jamble.Settings.toJSON())
          }).then(function(res){ if (!res.ok) throw new Error('Save failed'); return res.text(); })
            .then(function(){
              // Load the saved profile to set activeName/baseline and refresh dropdown
              var url = 'dist/profiles/' + name;
              window.Jamble.Settings.loadFrom(url).then(function(){ populateProfiles(); syncFromSettings(); markBaseline(); });
            })
            .catch(function(err){ console.error(err); });
        }
        function loadSelectedProfile(){
          if (!profileSel || !profileSel.value) return;
          var url = 'dist/profiles/' + profileSel.value;
          window.Jamble.Settings.loadFrom(url).then(function(){ syncFromSettings(); markBaseline(); });
        }
        if (saveBtn) saveBtn.addEventListener('click', saveProfile);
        if (revertBtn) revertBtn.addEventListener('click', revertProfile);
        if (profileSel) profileSel.addEventListener('change', loadSelectedProfile);
        if (saveAsBtn) saveAsBtn.addEventListener('click', saveAsProfile);

        // Prevent debug interactions from triggering game pointer handler
        var dbg = document.getElementById('jamble-debug');
        if (dbg){
          dbg.addEventListener('pointerdown', function(ev){ ev.stopPropagation(); });
          dbg.addEventListener('click', function(ev){ ev.stopPropagation(); });
        }

        // Initial sync and after settings load (HTTP mode)
        syncFromSettings();
        // Establish initial baseline after the initial HTTP load finishes
        window.addEventListener('jamble:settingsLoaded', function(){ syncFromSettings(); markBaseline(); populateProfiles(); });
      })();
    </script>
  </body>
  </html>
